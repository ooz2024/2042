<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>2048 - ç»„ç»‡æœºå¯†ç‰ˆ</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{ box-sizing:border-box; }

body{
  margin:0;
  background:
    radial-gradient(circle at top, #2a3a2a 0%, #0f1410 60%),
    linear-gradient(180deg, #1a1a1a, #0e0e0e);
  color:#f5f5f5;
  font-family:monospace;
  display:flex;
  justify-content:center;
  padding:40px 0;
  overflow-x: hidden; /* å½»åº•ç¦æ­¢é¡µé¢æ¨ªæ»‘ */
}

.game{
  position: relative;
  z-index: 2;
  background:#2b2b2b;
  padding:14px;
  border-radius:8px;
  width:360px;
  display:flex;
  flex-direction:column;
  gap:10px;
  margin:0 auto;
}

.top{
  display:flex;
  justify-content:space-between;
  font-size:14px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(4,70px);
  gap:6px;
  background:#555;
  padding:6px;
  border-radius:6px;
  justify-content:center;
  touch-action:none;
}

.cell{
  background:#777;
  height:70px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:26px;
  font-weight:bold;
  border-radius:4px;
  transition: transform 0.12s ease, background-color 0.15s ease;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
}

/* æ–¹å—é…è‰²ç³»ç»Ÿ */
.v2    { background:#e74c3c; color:#fff; }
.v4    { background:#27ae60; color:#fff; }
.v8    { background:#f1c40f; color:#000; }
.v16   { background:#e67e22; color:#fff; }
.v32   { background:#d35400; color:#fff; }
.v64   { background:#c0392b; color:#fff; }
.v128  { background:#1abc9c; color:#fff; box-shadow: 0 0 10px #1abc9c; }
.v256  { background:#3498db; color:#fff; box-shadow: 0 0 12px #3498db; }
.v512  { background:#9b59b6; color:#fff; box-shadow: 0 0 15px #9b59b6; }
.v1024 { background:#f39c12; color:#fff; box-shadow: 0 0 20px #f39c12; }
.v2048, .v4096, .v8192, .v16384 { 
  background: #111; 
  color: #00ffcc; 
  border: 2px solid #00ffcc; 
  box-shadow: 0 0 25px #00ffcc; 
}

button{
  background:#444;
  color:#fff;
  border:none;
  padding:8px;
  border-radius:4px;
  cursor:pointer;
}

/* æ’è¡Œæ¦œæ ·å¼ï¼šç¦æ­¢å·¦å³æ»‘åŠ¨ */
.rank{
  background:#1f1f1f;
  border-radius:6px;
  padding:8px;
  font-size:12px;
  display:flex;
  flex-direction:column;
  gap:6px;
  overflow-x: hidden; /* ğŸ”’ å…³é”®ï¼šç¦æ­¢æ’è¡Œæ¦œæœ¬èº«æ¨ªå‘æ»šåŠ¨ */
}

.rank-title { 
  display: flex; 
  align-items: center; 
  justify-content: space-between; 
  font-weight: bold; 
  border-bottom: 1px solid #444; 
  padding-bottom: 4px; 
}

.refresh-btn {
  background: #333;
  color: #fff;
  border: none;
  padding: 2px 6px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 10px;
  transition: background 0.2s;
}
.refresh-btn:hover { background: #555; }
.rank-spacer { width: 35px; }

/* æ¦œå•åˆ—å¸ƒå±€ï¼šä¸¥æ ¼é™åˆ¶æ€»å®½åº¦ */
.rank-header, .rank-row { 
  display: grid; 
  grid-template-columns: 30px 1fr 50px 110px; /* è°ƒæ•´äº†æ¯”ä¾‹ï¼Œé˜²æ­¢è¶…å‡ºå®¹å™¨å®½åº¦ */
  gap: 4px; 
  align-items: center; 
}

.rank-header { color:#aaa; }
.rank-index { text-align: right; color: #fff; }
.rank-list { max-height:160px; overflow-y:auto; overflow-x:hidden; } /* ç¦æ­¢å­åˆ—è¡¨æ¨ªç§» */
.rank-name { overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
.rank-score { text-align:center; }
.rank-time { text-align:right; opacity:0.8; font-size:10px; padding-right:2px; white-space: nowrap;}

/* å¼¹çª— */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1100;
}
.modal-box{
  background:#2b2b2b;
  padding:16px;
  border-radius:8px;
  width:320px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.hint { text-align: center; font-size: 12px; color: #fff; letter-spacing: 2px; }

@keyframes pop { 0% { transform: scale(0.8); } 100% { transform: scale(1); } }
.cell.moved{ animation: pop 0.12s ease; }
@keyframes spawn { 0% { transform: scale(0.3); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
.cell.spawn{ animation: spawn 0.2s ease-out; }

/* é›ªèŠ± */
.snow-container { position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 0; }
.snow-container span { position: absolute; top: -20px; animation: fall linear infinite; filter: blur(1px); }
@keyframes fall {
  0% { transform: translateY(-20px) rotate(0deg); opacity: 0; }
  10% { opacity: var(--op, 0.4); }
  90% { opacity: var(--op, 0.4); }
  100% { transform: translateY(110vh) translateX(var(--sw, 50px)) rotate(var(--r, 360deg)); opacity: 0; }
}
</style>
</head>

<body>
<div class="snow-container" id="snow-bg"></div>

<div class="game">
  <div class="top">
    <div>å¾—åˆ†ï¼š<span id="score">0</span></div>
    <div id="status"></div>
  </div>
  <div class="grid" id="grid"></div>
  <div class="hint">â¬†ï¸ â¬…ï¸ â¬‡ï¸ â¡ï¸ ç§»åŠ¨æ–¹å—</div>
  <button onclick="restart()">é‡æ–°å¼€å§‹</button>
  <div class="rank" id="rank">æ­£åœ¨è¯»å–ç»„ç»‡æœºå¯†â€¦</div>
</div>

<div class="modal" id="modal">
  <div class="modal-box">
    <div class="modal-title" style="text-align:center; font-weight:bold;">Game over!</div>
    <div class="modal-score">ä½ çš„å¾—åˆ†æ˜¯ï¼š<span id="finalScore"></span></div>
    <div style="font-size:13px; opacity:0.8; margin-bottom:4px;">è¯·è¾“å…¥æ˜µç§°...ç»„ç»‡ä¸Šä¼šè®°ä½ä½ çš„!</div>
    <input id="playerName" placeholder="åŒ¿åç©å®¶" maxlength="16" style="width:100%; padding:6px; border-radius:4px; border:none;">
    <div style="display:flex; gap:8px; justify-content:center; margin-top:8px;">
      <button onclick="submitScore()">è®°å…¥ç»„ç»‡</button>
      <button onclick="closeModal()">æ¦‚ä¸ç•™å</button>
    </div>
  </div>
</div>

<script>
const supabaseUrl = "https://hivlyphuvzvwnobnoqdl.supabase.co";
const supabaseKey = "sb_publishable_B3tNHsrkG6U2wu9jW64smA_XtfaDNM0";
const db = supabase.createClient(supabaseUrl, supabaseKey);

let grid = Array(16).fill(0);
let score = 0;
let gameOver = false;
let spawnedIndex = null;
let lastGrid = Array(16).fill(0);

const gridEl = document.getElementById("grid");
const scoreEl = document.getElementById("score");
const rankEl = document.getElementById("rank");

function draw(){
  gridEl.innerHTML="";
  grid.forEach((v,i)=>{
    let d = document.createElement("div");
    let colorClass = v > 2048 ? "v2048" : "v"+v;
    d.className = "cell" + (v ? " " + colorClass : "");
    if(v !== lastGrid[i]) d.classList.add("moved");
    if(i === spawnedIndex) d.classList.add("spawn");
    d.textContent = v || "";
    gridEl.appendChild(d);
  });
  lastGrid = [...grid];
  spawnedIndex = null;
  scoreEl.textContent = score;
}

function randomAdd(){
  let e = grid.map((v,i)=>v===0?i:null).filter(v=>v!==null);
  if(!e.length) return;
  spawnedIndex = e[Math.floor(Math.random()*e.length)];
  grid[spawnedIndex] = Math.random() < 0.9 ? 2 : 4;
}

function slide(arr){
  arr=arr.filter(v=>v);
  for(let i=0;i<arr.length-1;i++){
    if(arr[i]===arr[i+1]){ arr[i]*=2; score+=arr[i]; arr[i+1]=0; }
  }
  arr=arr.filter(v=>v);
  while(arr.length<4)arr.push(0);
  return arr;
}

function move(dir){
  if(gameOver) return;
  let moved=false;
  let g=[...grid];
  const idx=(i,j)=>{
    if(dir==="L")return i*4+j;
    if(dir==="R")return i*4+3-j;
    if(dir==="U")return j*4+i;
    return 12-j*4+i;
  };
  for(let i=0;i<4;i++){
    let line=[];
    for(let j=0;j<4;j++)line.push(g[idx(i,j)]);
    let s=slide(line);
    for(let j=0;j<4;j++){
      let k=idx(i,j);
      if(grid[k]!==s[j]){grid[k]=s[j];moved=true;}
    }
  }
  if(moved){ randomAdd(); draw(); checkOver(); }
}

function checkOver(){
  if(grid.includes(0))return;
  for(let i=0;i<16;i++){
    if(i%4<3 && grid[i]===grid[i+1])return;
    if(i<12 && grid[i]===grid[i+4])return;
  }
  gameOver = true;
  document.getElementById("finalScore").textContent = score;
  document.getElementById("modal").style.display = "flex";
}

function formatDateTime(dateStr){
  if(!dateStr) return "";
  const utc = new Date(dateStr).getTime();
  const beijing = new Date(utc + 8*60*60*1000);
  const Y = beijing.getFullYear();
  const M = String(beijing.getMonth()+1).padStart(2,"0");
  const D = String(beijing.getDate()).padStart(2,"0");
  const h = String(beijing.getHours()).padStart(2,"0");
  const m = String(beijing.getMinutes()).padStart(2,"0");
  const s = String(beijing.getSeconds()).padStart(2,"0");
  return `${Y}-${M}-${D} ${h}:${m}:${s}`;
}

async function loadRank(){
  rankEl.style.opacity = "0.7"; 
  try {
    let { data, error } = await db.from("scores").select("*").order("score",{ ascending:false }).limit(50);
    if(error) throw error;
    
    rankEl.innerHTML=`
      <div class="rank-title">
        <button class="refresh-btn" onclick="loadRank()">åˆ·æ–°</button>
        <div style="flex:1; text-align:center;">ğŸŒ ç»„ç»‡æ’è¡Œæ¦œ â­</div>
        <div class="rank-spacer"></div> 
      </div>
      <div class="rank-header">
        <div class="rank-index">#</div>
        <div>ç©å®¶</div>
        <div class="rank-score">åˆ†æ•°</div> 
        <div style="text-align:right; padding-right:6px;">æ—¶é—´</div>
      </div>
      <div class="rank-list">
        ${data.map((v,i)=>`
          <div class="rank-row">
            <div class="rank-index">${i===0?"ğŸ‘‘1":i+1}</div>
            <div class="rank-name" style="color:${i<3?['#FFD700','#C0C0C0','#CD7F32'][i]:'#e0e0e0'}">${v.name}</div>
            <div class="rank-score">${v.score}</div> 
            <div class="rank-time">${formatDateTime(v.created_at)}</div>
          </div>`).join("")}
      </div>`;
  } catch (err) {
    rankEl.innerHTML = `
      <div class="rank-title">
        <button class="refresh-btn" onclick="loadRank()">é‡è¯•</button>
        <div style="flex:1; text-align:center;">åŒæ­¥å¤±è´¥ ğŸ“¡</div>
        <div class="rank-spacer"></div>
      </div>
      <div style="text-align:center; padding:20px; font-size:11px; opacity:0.6;">ç½‘ç»œè¿æ¥ä¸ç¨³å®šï¼Œè¯·ç‚¹å‡»é‡è¯•</div>`;
  } finally {
    rankEl.style.opacity = "1";
  }
}

document.addEventListener("keydown", e => {
  if (["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(e.key)) e.preventDefault();
  if(e.key==="ArrowLeft") move("L"); if(e.key==="ArrowRight") move("R");
  if(e.key==="ArrowUp") move("U"); if(e.key==="ArrowDown") move("D");
});

let sx, sy;
gridEl.addEventListener("touchstart", e=>{ sx=e.touches[0].clientX; sy=e.touches[0].clientY; },{passive:false});
gridEl.addEventListener("touchend", e=>{
  let dx=e.changedTouches[0].clientX-sx; let dy=e.changedTouches[0].clientY-sy;
  if(Math.abs(dx)>Math.abs(dy)){ if(Math.abs(dx)>30) move(dx>0?"R":"L"); }
  else { if(Math.abs(dy)>30) move(dy>0?"D":"U"); }
},{passive:false});

function restart(){ grid.fill(0); score=0; gameOver=false; randomAdd(); randomAdd(); draw(); document.getElementById("modal").style.display="none"; }
function closeModal(){ document.getElementById("modal").style.display="none"; }

async function submitScore(){
  const btn = event.target;
  const nameInput = document.getElementById("playerName");
  let name = nameInput.value.trim() || "åŒ¿åç©å®¶";

  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "ä¼ é€ä¸­...";
  btn.style.opacity = "0.5";

  try {
    const { error } = await db.from("scores").insert({ name, score });
    if (error) throw error;
    closeModal();
    await loadRank(); 
  } catch (err) {
    alert("ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•");
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
    btn.style.opacity = "1";
  }
}

function initSnow() {
  const bg = document.getElementById("snow-bg");
  bg.innerHTML = "";
  for(let i=0; i<80; i++) {
    const s = document.createElement("span");
    s.textContent = ["â„ï¸", "â„ï¸", "ğŸ„", "ğŸ"][Math.floor(Math.random()*4)];
    s.style.left = Math.random() * 100 + "vw";
    s.style.fontSize = (8 + Math.random()*15) + "px";
    s.style.animationDuration = (6 + Math.random()*12) + "s";
    s.style.animationDelay = Math.random() * -20 + "s";
    s.style.setProperty('--sw', (Math.random()*160 - 80) + "px");
    s.style.setProperty('--r', Math.random()*720 + "deg");
    s.style.setProperty('--op', (0.3 + Math.random()*0.3));
    bg.appendChild(s);
  }
}

restart(); loadRank(); initSnow();
</script>
</body>
</html>
