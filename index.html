<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2048 Terminal</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>


<style>
*{ box-sizing:border-box; }

body{
  margin:0;
  background:#1e1e1e;
  color:#e0e0e0;
  font-family:monospace;
  display:flex;
  justify-content:center;
  padding:40px 0;   /* ğŸ”¥ å…³é”® */
}


/* ğŸ”’ æ ¸å¿ƒï¼šç¦ç”¨æ¸¸æˆåŒºåŸŸçš„æµè§ˆå™¨è§¦æ‘¸è¡Œä¸º */
.game{
  background:#2b2b2b;
  padding:14px;
  border-radius:8px;
  width:360px;
  display:flex;
  flex-direction:column;
  gap:10px;
  margin:0 auto;
}


/* é¡¶éƒ¨ */
.top{
  display:flex;
  justify-content:space-between;
  font-size:14px;
}

/* æ¸¸æˆåŒº */
.grid{
  display:grid;
  grid-template-columns:repeat(4,70px);
  gap:6px;
  background:#555;
  padding:6px;
  border-radius:6px;
  justify-content:center;
  touch-action:none;   /* âœ… åªç¦æ¸¸æˆåŒº */
}

.cell{
  background:#777;
  height:70px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:26px;
  font-weight:bold;
  border-radius:4px;
}

.v2{background:#d64c4c;color:#fff}
.v4{background:#2ecc71;color:#fff}
.v8{background:#3498db;color:#fff}
.v16{background:#9b59b6;color:#fff}
.v32{background:#f1c40f}
.v64{background:#e67e22}
.v128,.v256,.v512,.v1024,.v2048{
  background:#1abc9c;color:#000
}

button{
  background:#444;
  color:#fff;
  border:none;
  padding:8px;
  border-radius:4px;
  cursor:pointer;
}

/* æ’è¡Œæ¦œ */
.rank{
  background:#1f1f1f;
  border-radius:6px;
  padding:8px;
  font-size:12px;
  display:flex;
  flex-direction:column;
  gap:6px;
}

.rank-title{
  font-weight:bold;
  text-align:center;
  border-bottom:1px solid #444;
  padding-bottom:4px;
}

.rank-header,
.rank-row{
  display:grid;
  grid-template-columns:28px 1fr 60px 120px;
  gap:6px;
  align-items:center;
}

.rank-index{
  text-align:right;
  opacity:0.6;
}

.rank-header{
  color:#aaa;
}

.rank-list{
  max-height:160px;
  overflow-y:auto;
}

.rank-name{
  overflow:hidden;
  white-space:nowrap;
  text-overflow:ellipsis;
}

.rank-score{
  text-align:center;
}

.rank-time{
  text-align:right;
  opacity:0.8;
  font-size:11px;
  padding-right:6px;
}
</style>
</head>

<body>
<div class="game">
  <div class="top">
    <div>å¾—åˆ†ï¼š<span id="score">0</span></div>
    <div id="status"></div>
  </div>

  <div class="grid" id="grid"></div>

  <button onclick="restart()">é‡æ–°å¼€å§‹</button>

  <div class="rank" id="rank">æ­£åœ¨åŠ è½½æ’è¡Œæ¦œâ€¦</div>
</div>

<script>
/* Supabase */
const supabaseUrl = "https://hivlyphuvzvwnobnoqdl.supabase.co";
const supabaseKey = "sb_publishable_B3tNHsrkG6U2wu9jW64smA_XtfaDNM0";
const db = supabase.createClient(supabaseUrl, supabaseKey);

/* æ¸¸æˆ */
let grid = Array(16).fill(0);
let score = 0;

const gridEl = document.getElementById("grid");
const scoreEl = document.getElementById("score");
const statusEl = document.getElementById("status");
const rankEl = document.getElementById("rank");

function draw(){
  gridEl.innerHTML="";
  grid.forEach(v=>{
    let d=document.createElement("div");
    d.className="cell"+(v?" v"+v:"");
    d.textContent=v||"";
    gridEl.appendChild(d);
  });
  scoreEl.textContent=score;
}

function randomAdd(){
  let e=grid.map((v,i)=>v===0?i:null).filter(v=>v!==null);
  if(!e.length)return;
  grid[e[Math.floor(Math.random()*e.length)]]=Math.random()<0.9?2:4;
}

function slide(arr){
  arr=arr.filter(v=>v);
  for(let i=0;i<arr.length-1;i++){
    if(arr[i]===arr[i+1]){
      arr[i]*=2;
      score+=arr[i];
      arr[i+1]=0;
    }
  }
  arr=arr.filter(v=>v);
  while(arr.length<4)arr.push(0);
  return arr;
}

function move(dir){
  let moved=false;
  let g=[...grid];
  const idx=(i,j)=>{
    if(dir==="L")return i*4+j;
    if(dir==="R")return i*4+3-j;
    if(dir==="U")return j*4+i;
    return 12-j*4+i;
  };
  for(let i=0;i<4;i++){
    let line=[];
    for(let j=0;j<4;j++)line.push(g[idx(i,j)]);
    let s=slide(line);
    for(let j=0;j<4;j++){
      let k=idx(i,j);
      if(grid[k]!==s[j]){grid[k]=s[j];moved=true;}
    }
  }
  if(moved){
    randomAdd();
    draw();
    checkOver();
  }
}

function checkOver(){
  if(grid.includes(0))return;
  for(let i=0;i<16;i++){
    if(i%4<3 && grid[i]===grid[i+1])return;
    if(i<12 && grid[i]===grid[i+4])return;
  }

  statusEl.textContent = "æ¸¸æˆç»“æŸ";
  setTimeout(saveScore, 100);
}


/* æ’è¡Œæ¦œ */
function formatTime(t){
  const utc = new Date(t).getTime();
  const beijing = new Date(utc + 8 * 60 * 60 * 1000);

  const Y = beijing.getFullYear();
  const M = String(beijing.getMonth() + 1).padStart(2, "0");
  const D = String(beijing.getDate()).padStart(2, "0");
  const h = String(beijing.getHours()).padStart(2, "0");
  const m = String(beijing.getMinutes()).padStart(2, "0");
  const s = String(beijing.getSeconds()).padStart(2, "0");

  return `${Y}-${M}-${D} ${h}:${m}:${s}`;
}


async function saveScore(){
  let name = prompt(`æ¸¸æˆç»“æŸï¼\nä½ çš„å¾—åˆ†æ˜¯ï¼š${score}\n\nè¯·è¾“å…¥ä½ çš„åå­—ï¼š`, "åŒ¿åç©å®¶");
  if(!name) return;

  await db.from("scores").insert({
    name,
    score
  });

  loadRank();
}

async function loadRank(){
  let { data } = await db
    .from("scores")
    .select("*")
    .order("score",{ ascending:false })
    .limit(50);

  rankEl.innerHTML=`
    <div class="rank-title">ğŸŒ å…¨çƒæ’è¡Œæ¦œ</div>
    <div class="rank-header">
      <div>#</div><div>åå­—</div><div>å¾—åˆ†</div><div>æ—¶é—´</div>
    </div>
    <div class="rank-list">
      ${data.map((v,i)=>`
        <div class="rank-row">
          <div class="rank-index">${i+1}</div>
          <div class="rank-name" title="${v.name}">${v.name}</div>
          <div class="rank-score">${v.score}</div>
          <div class="rank-time">${formatTime(v.created_at)}</div>
        </div>
      `).join("")}
    </div>
  `;
}

/* é”®ç›˜ */
document.addEventListener("keydown", e => {
  if (["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(e.key)) {
    e.preventDefault(); // ğŸ”’ ç¦æ­¢æµè§ˆå™¨æ»šé¡µé¢
  }

  if(e.key==="ArrowLeft") move("L");
  if(e.key==="ArrowRight") move("R");
  if(e.key==="ArrowUp") move("U");
  if(e.key==="ArrowDown") move("D");
});

/* ğŸ“± åªåœ¨æ¸¸æˆåŒºåŸŸæ‹¦æˆªæ»‘åŠ¨ */
let sx, sy;

gridEl.addEventListener("touchstart", e=>{
  e.preventDefault();
  sx = e.touches[0].clientX;
  sy = e.touches[0].clientY;
},{ passive:false });

gridEl.addEventListener("touchend", e=>{
  e.preventDefault();
  let dx = e.changedTouches[0].clientX - sx;
  let dy = e.changedTouches[0].clientY - sy;

  if(Math.abs(dx) > Math.abs(dy)){
    if(dx > 30) move("R");
    if(dx < -30) move("L");
  }else{
    if(dy > 30) move("D");
    if(dy < -30) move("U");
  }
},{ passive:false });


function restart(){
  grid.fill(0);
  score=0;
  statusEl.textContent="";
  randomAdd();randomAdd();
  draw();
}

/* å¯åŠ¨ */
restart();
loadRank();
</script>
</body>
</html>

